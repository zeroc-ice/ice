name: "Publish GEM Packages"

on:
  workflow_dispatch:
    inputs:
      channel:
        description: "The release channel (e.g., 3.9, 3.8)"
        required: true
      quality:
        description: "Release quality (e.g., stable, nightly, RC)"
        required: true
        default: "nightly"
      run_id:
        description: "The run ID to use for downloading artifacts"
        required: true
  workflow_call:
    inputs:
      channel:
        required: true
        type: string
      quality:
        required: true
        type: string
      run_id:
        required: true
        type: string

jobs:
  build:
    name: "Publish GEM Packages"
    runs-on: ubuntu-24.04

    steps:
      - name: Download GEM artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_ID: ${{ inputs.run_id }}
        run: |
          gh run download "$RUN_ID" --repo zeroc-ice/ice --pattern "gem-packages" --dir staging

      - name: Publish Nightly GEM Packages
        if: ${{ inputs.quality == 'nightly' }}
        run: |
          curl -u "nightly:${NEXUS_NIGHTLY_PASSWORD}" \
            --upload-file staging/gem-packages/zeroc-ice-*.gem \
            --output /dev/null \
            --silent \
            --retry 3 \
            --fail \
            --show-error \
            https://download.zeroc.com/nexus/repository/rubygems-${CHANNEL}-${QUALITY}/gems/ \
            || { echo "Gem upload failed"; exit 1; }
        env:
          NEXUS_NIGHTLY_PASSWORD: ${{ secrets.NEXUS_NIGHTLY_PASSWORD }}
          CHANNEL: ${{ inputs.channel }}
          QUALITY: ${{ inputs.quality }}

      - name: Publish Release GEM Packages
        if: ${{ inputs.quality == 'stable' }}
        run: |
          GEM_HOST_API_KEY="${RUBYGEMS_API_KEY}" gem push staging/gem-packages/zeroc-ice-*.gem
        env:
          RUBYGEMS_API_KEY: ${{ secrets.RUBYGEMS_API_KEY }}
