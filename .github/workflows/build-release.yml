name: Build Release

on:
  workflow_call:
    inputs:
      build_number:
        required: false
        default: "1"
        type: string
      quality:
        required: true
        type: string
      publish:
        required: false
        type: boolean
        default: false
      authenticode_sign:
        description: "Whether to Authenticode sign Windows binaries (always true for stable quality)"
        required: false
        type: boolean
        default: false

  workflow_dispatch:
    inputs:
      build_number:
        description: "Build number for nightly releases"
        required: false
        default: "1"
      quality:
        description: "Release quality (e.g., stable, nightly, RC)"
        required: true
        default: "nightly"
      publish:
        description: "Whether to publish the packages"
        required: false
        default: false
        type: boolean
      authenticode_sign:
        description: "Whether to Authenticode sign Windows binaries (always true for stable quality)"
        required: false
        default: false
        type: boolean

jobs:
  configure:
    runs-on: ubuntu-24.04
    outputs:
      semver_version: ${{ steps.configure.outputs.semver_version }}
      deb_version: ${{ steps.configure.outputs.deb_version }}
      gem_version: ${{ steps.configure.outputs.gem_version }}
      maven_version: ${{ steps.configure.outputs.maven_version }}
      pypi_version: ${{ steps.configure.outputs.pypi_version }}
      rpm_version: ${{ steps.configure.outputs.rpm_version }}
      matlab_version: ${{ steps.configure.outputs.matlab_version }}
      channel: ${{ steps.configure.outputs.channel }}
      authenticode_sign: ${{ steps.configure.outputs.authenticode_sign }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure build
        id: configure
        run: |
          # Load version information
          source ./config/version.env
          # The channel for the branch from version.env
          echo "channel=${CHANNEL}" >> $GITHUB_OUTPUT
          # Authenticode sign is always true for stable quality, otherwise use the input value
          if [[ "${{ inputs.quality }}" == "stable" ]] || [[ "${{ inputs.authenticode_sign }}" == "true" ]]; then
            echo "authenticode_sign=true" >> $GITHUB_OUTPUT
          else
            echo "authenticode_sign=false" >> $GITHUB_OUTPUT
          fi
          if [[ "${{ inputs.quality }}" == "nightly" ]]; then
            DATE=$(date +%Y%m%d)
            BUILD=${{ inputs.build_number }}
            # Set version variables for nightly packages according to platform conventions:

            # e.g. 3.9.0-nightly.20250625.1
            echo "semver_version=${BASE_VERSION}-nightly.${DATE}.${BUILD}" >> $GITHUB_OUTPUT

            # e.g. 3.9.0~0.nightly20250625.1-1
            echo "deb_version=${BASE_VERSION}~0.nightly${DATE}.${BUILD}-1" >> $GITHUB_OUTPUT

            # e.g. 3.9.0.pre.20250625.1
            echo "gem_version=${BASE_VERSION}.pre.${DATE}.${BUILD}" >> $GITHUB_OUTPUT

            # e.g. 3.9.0-nightly-20250625.1-SNAPSHOT
            echo "maven_version=${BASE_VERSION}-nightly-${DATE}.${BUILD}-SNAPSHOT" >> $GITHUB_OUTPUT

            # e.g. 3.9.0.dev202506251
            echo "pypi_version=${BASE_VERSION}.dev${DATE}${BUILD}" >> $GITHUB_OUTPUT

            # e.g. 3.9.0~0.nightly20250625.1
            echo "rpm_version=${BASE_VERSION}~0.nightly${DATE}.${BUILD}" >> $GITHUB_OUTPUT

            # e.g. 3.9.0.202506251
            echo "matlab_version=${BASE_VERSION}.${DATE}${BUILD}" >> $GITHUB_OUTPUT
          else
            # Define version variables as empty for stable channels to use the version from the repository
            echo "semver_version=" >> $GITHUB_OUTPUT
            echo "deb_version=" >> $GITHUB_OUTPUT
            echo "gem_version=" >> $GITHUB_OUTPUT
            echo "maven_version=" >> $GITHUB_OUTPUT
            echo "pypi_version=" >> $GITHUB_OUTPUT
            echo "rpm_version=" >> $GITHUB_OUTPUT
            echo "matlab_version=" >> $GITHUB_OUTPUT
          fi

  build-brew-packages:
    name: Build Brew Packages
    uses: ./.github/workflows/build-brew-packages.yml
    needs:
      - configure
      - build-icegridgui-macos-app
    with:
      ice_version: ${{ needs.configure.outputs.semver_version }}
      channel: ${{ needs.configure.outputs.channel }}
      quality: ${{ inputs.quality }}
      run_id: ${{ github.run_id }}
    secrets: inherit

  build-deb-packages:
    name: Build DEB Packages
    uses: ./.github/workflows/build-deb-packages.yml
    needs: configure
    with:
      ice_version: ${{ needs.configure.outputs.deb_version }}
    secrets: inherit

  build-dotnet-packages:
    name: Build .NET Packages
    uses: ./.github/workflows/build-dotnet-packages.yml
    needs: configure
    with:
      ice_version: ${{ needs.configure.outputs.semver_version }}
      authenticode_sign: ${{ needs.configure.outputs.authenticode_sign == 'true' }}
    secrets: inherit

  build-gem-packages:
    name: Build GEM Packages
    uses: ./.github/workflows/build-gem-packages.yml
    needs: configure
    with:
      ice_version: ${{ needs.configure.outputs.gem_version }}

  build-matlab-packages:
    name: Build MATLAB Packages
    uses: ./.github/workflows/build-matlab-packages.yml
    needs: configure
    with:
      ice_version: ${{ needs.configure.outputs.matlab_version }}
      authenticode_sign: ${{ needs.configure.outputs.authenticode_sign == 'true' }}
    secrets: inherit

  build-java-packages:
    name: Build Java Packages
    uses: ./.github/workflows/build-java-packages.yml
    needs: configure
    with:
      ice_version: ${{ needs.configure.outputs.maven_version }}
    secrets: inherit

  build-slice-tools-packages:
    name: Build Slice Tools Packages
    uses: ./.github/workflows/build-slice-tools-packages.yml
    needs: configure
    with:
      ice_version: ${{ needs.configure.outputs.maven_version }}
      authenticode_sign: ${{ needs.configure.outputs.authenticode_sign == 'true' }}
    secrets: inherit

  build-npm-packages:
    name: Build NPM Packages
    uses: ./.github/workflows/build-npm-packages.yml
    needs: configure
    with:
      ice_version: ${{ needs.configure.outputs.semver_version }}
      authenticode_sign: ${{ needs.configure.outputs.authenticode_sign == 'true' }}
    secrets: inherit

  build-pip-packages:
    name: Build PIP Packages
    uses: ./.github/workflows/build-pip-packages.yml
    needs: configure
    with:
      ice_version: ${{ needs.configure.outputs.pypi_version }}
    secrets: inherit

  build-rpm-packages:
    name: Build RPM Packages
    uses: ./.github/workflows/build-rpm-packages.yml
    needs: configure
    with:
      ice_version: ${{ needs.configure.outputs.rpm_version }}
    secrets: inherit

  build-cpp-windows-binaries:
    name: Build C++ Windows Binaries
    uses: ./.github/workflows/build-cpp-windows-binaries.yml
    needs: configure
    with:
      ice_version: ${{ needs.configure.outputs.semver_version }}
      authenticode_sign: ${{ needs.configure.outputs.authenticode_sign == 'true' }}
    secrets: inherit

  build-symbols-sources-store:
    name: Build Symbols and Sources Store
    uses: ./.github/workflows/build-symbols-sources-store.yml
    needs:
      - configure
      - build-cpp-windows-binaries
    with:
      ice_version: ${{ needs.configure.outputs.semver_version }}
      channel: ${{ needs.configure.outputs.channel }}
      quality: ${{ inputs.quality }}
      run_id: ${{ github.run_id }}
    secrets: inherit

  build-cpp-nuget-packages:
    name: Build C++ NuGet Packages
    uses: ./.github/workflows/build-cpp-nuget-packages.yml
    needs:
      - configure
      - build-cpp-windows-binaries
    with:
      ice_version: ${{ needs.configure.outputs.semver_version }}
      run_id: ${{ github.run_id }}
    secrets: inherit

  build-icegridgui-jar:
    name: Build IceGrid GUI JAR
    uses: ./.github/workflows/build-icegridgui-jar.yml
    needs: configure
    with:
      ice_version: ${{ needs.configure.outputs.semver_version }}
    secrets: inherit

  build-windows-installer:
    name: Build Windows Installer
    uses: ./.github/workflows/build-windows-installer.yml
    needs:
      - configure
      - build-cpp-windows-binaries
      - build-icegridgui-jar
    with:
      run_id: ${{ github.run_id }}
      authenticode_sign: ${{ needs.configure.outputs.authenticode_sign == 'true' }}
    secrets: inherit

  build-icegridgui-macos-app:
    name: Build IceGrid GUI macOS App
    uses: ./.github/workflows/build-icegridgui-macos-app.yml
    needs:
      - configure
      - build-icegridgui-jar
    with:
      run_id: ${{ github.run_id }}
      dmg_version: ${{ needs.configure.outputs.semver_version }}
    secrets: inherit

  build-cpp-swift-deps:
    name: Build macOS Packages
    uses: ./.github/workflows/build-cpp-swift-deps.yml
    needs: configure
    with:
      ice_version: ${{ needs.configure.outputs.semver_version }}
      channel: ${{ needs.configure.outputs.channel }}
    secrets: inherit

  build-all:
    name: Build All Packages
    runs-on: ubuntu-24.04
    needs:
      - build-brew-packages
      - build-deb-packages
      - build-dotnet-packages
      - build-gem-packages
      - build-matlab-packages
      - build-java-packages
      - build-slice-tools-packages
      - build-npm-packages
      - build-pip-packages
      - build-rpm-packages
      - build-windows-installer
      - build-icegridgui-macos-app
      - build-cpp-swift-deps
      - build-symbols-sources-store
      - build-cpp-nuget-packages
    steps:
      - run: echo "All packages built successfully"

  prune-nightly-artifacts:
    name: Prune Nightly Artifacts
    if: ${{ inputs.publish == true && inputs.quality == 'nightly' }}
    needs:
      - configure
      - build-all
    uses: ./.github/workflows/prune-nightly-artifacts.yml
    with:
      channel: ${{ needs.configure.outputs.channel }}
    secrets: inherit

  publish-release:
    name: Publish Release
    if: ${{ inputs.publish == true }}
    needs:
      - configure
      - build-all
      - prune-nightly-artifacts
    uses: ./.github/workflows/publish-release.yml
    with:
      channel: ${{ needs.configure.outputs.channel }}
      quality: ${{ inputs.quality }}
      run_id: ${{ github.run_id }}
    secrets: inherit
