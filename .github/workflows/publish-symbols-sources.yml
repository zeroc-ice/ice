name: "Publish Symbols and Sources"

on:
  workflow_dispatch:
    inputs:
      channel:
        description: "The release channel (e.g., 3.7, 3.8)"
        required: true
      quality:
        description: "Release quality (e.g., stable, nightly, RC)"
        required: true
        default: "nightly"
      run_id:
        description: "The run ID to use for downloading artifacts"
        required: true
  workflow_call:
    inputs:
      channel:
        required: true
        type: string
      quality:
        required: true
        type: string
      run_id:
        required: true
        type: string

jobs:
  # Non-stable releases (nightly, RC) - simple sync to quality-specific paths
  publish-symbols-sources-nightly:
    name: "Publish Symbols and Sources (Non-Stable)"
    if: ${{ inputs.quality != 'stable' }}
    runs-on: ubuntu-24.04
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      S3_BUCKET: zeroc-downloads
      S3_UPLOAD_PATH: ice/${{ inputs.quality }}/${{ inputs.channel }}
    strategy:
      matrix:
        platform-toolset: [v143, v142]
    steps:
      - name: Download Symbols and Sources artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh run download "${{ inputs.run_id }}" --repo zeroc-ice/ice --pattern "windows-${{ matrix.platform-toolset }}-symbols-sources" --dir staging

      - name: Publish Symbols and Sources
        run: |
          # Upload sources to S3 (version is already in the directory structure)
          aws s3 sync "staging/windows-${{ matrix.platform-toolset }}-symbols-sources/sources/" "s3://${S3_BUCKET}/${S3_UPLOAD_PATH}/sources/"
          # Upload symbol store to S3 (separate store per toolset)
          aws s3 sync "staging/windows-${{ matrix.platform-toolset }}-symbols-sources/symbols/" "s3://${S3_BUCKET}/${S3_UPLOAD_PATH}/symbols/${{ matrix.platform-toolset }}/"

  # Stable releases - incremental update to shared symbol store with proper 000Admin handling
  # Downloads existing 000Admin, uses symstore add to create proper transaction, uploads result
  publish-symbols-sources-stable:
    name: "Publish Symbols and Sources (Stable)"
    if: ${{ inputs.quality == 'stable' }}
    runs-on: windows-2022
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      S3_BUCKET: zeroc-sourcesandsymbols
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Windows Debug Tools
        uses: ./.github/actions/install-windows-debug-tools

      - name: Download Symbols and Sources artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh run download "${{ inputs.run_id }}" --repo zeroc-ice/ice --pattern "windows-v143-symbols-sources" --dir staging
          gh run download "${{ inputs.run_id }}" --repo zeroc-ice/ice --pattern "windows-v142-symbols-sources" --dir staging

      - name: Read version from config
        id: version
        run: |
          source ./config/version.env
          echo "ice_version=${BASE_VERSION}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Download existing 000Admin from S3
        run: |
          $symbolStorePath = "symbol-store"
          New-Item -ItemType Directory -Force -Path $symbolStorePath
          # Download existing 000Admin from stable symbol store
          aws s3 sync "s3://${{ env.S3_BUCKET }}/symbols/000Admin/" "$symbolStorePath/000Admin/"
          if (-not (Test-Path "$symbolStorePath/000Admin/history.txt")) {
            Write-Error "No existing 000Admin found in stable symbol store - this should not happen"
            exit 1
          }
          Write-Host "Downloaded existing 000Admin"
        shell: pwsh

      - name: Add symbols to store using symstore
        run: |
          $symbolStorePath = "${{ github.workspace }}/symbol-store"

          # Add all PDBs from both toolsets in a single transaction
          # symstore /r recursively finds all PDBs under the staging directory
          symstore add /3 /compress /r `
            /t "Ice" `
            /v "${{ steps.version.outputs.ice_version }}" `
            /s $symbolStorePath `
            /f "${{ github.workspace }}/staging"
        shell: pwsh

      - name: Publish Symbols and Sources to S3
        run: |
          # Sources are the same for both toolsets, just sync one
          aws s3 sync "staging/windows-v143-symbols-sources/sources/" "s3://${S3_BUCKET}/sources/"

          # Sync the entire symbol store including 000Admin (single shared store, no platform-toolset)
          aws s3 sync "symbol-store/" "s3://${S3_BUCKET}/symbols/"
        shell: pwsh
