name: "Build Ice Repo RPM Packages"

on:
  workflow_dispatch:
    inputs:
      quality:
        description: "Release quality (e.g., stable, nightly, RC)"
        required: false
        default: "nightly"

jobs:
  build:
    name: "Build Ice Repo RPM packages for ${{ matrix.distribution }}"
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        distribution: [el9, el10, amzn2023]

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          path: ice

      - name: Load version info
        run: |
          source ice/config/version.env
          echo "CHANNEL=$CHANNEL" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: zeroc-ice
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build RPM packages
        run: |
          docker run --rm \
            -v "$GITHUB_WORKSPACE:/workspace" \
            -e GPG_KEY="${{ secrets.ICE_3_8_CI_SIGNER_KEY }}" \
            -e GPG_KEY_ID="${{ secrets.ICE_3_8_CI_SIGNER_KEY_ID }}" \
            ghcr.io/zeroc-ice/ice-rpm-builder-${{ matrix.distribution }}:${CHANNEL} \
            /workspace/ice/packaging/rpm/build-repo-package.sh \
            --distribution "${{ matrix.distribution }}" \
            --channel "${CHANNEL}" \
            --quality "${{ inputs.quality }}"

      - name: Sync RPM packages to S3
        run: |
          if [ "${QUALITY}" = "stable" ]; then
            UPLOAD_PATH="ice/${CHANNEL}/${DISTRIBUTION}"
          else
            UPLOAD_PATH="ice/${QUALITY}/${CHANNEL}/${DISTRIBUTION}"
          fi

          aws s3 cp build/RPMS/noarch/*.rpm "s3://zeroc-downloads/${UPLOAD_PATH}/"
        env:
          QUALITY: ${{ inputs.quality }}
          DISTRIBUTION: ${{ matrix.distribution }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-packages-${{ matrix.distribution }}
          path: |
            build/RPMS/*
            build/SRPMS/*
