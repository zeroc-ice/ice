name: "Dispatch Workflow"
description: "Trigger a workflow_dispatch on a given ref with optional inputs"
inputs:
  ref:
    description: "Git ref to dispatch"
    required: true
  workflow:
    description: "Workflow filename to dispatch"
    required: true
  token:
    description: "GitHub token with workflow scope"
    required: true
  inputs:
    description: "JSON object of inputs to pass to the workflow"
    required: false
    default: "{}"
runs:
  using: "composite"
  steps:
    - name: Dispatch workflow
      run: |
        set -euo pipefail
        echo "Dispatching ${WORKFLOW} on ref ${REF}"
        # Build -f flags from JSON inputs
        INPUT_ARGS=""
        if [[ "${INPUTS}" != "{}" ]]; then
          INPUT_ARGS=$(echo "${INPUTS}" | jq -r 'to_entries | .[] | "-f \(.key)=\(.value)"' | tr '\n' ' ')
        fi
        # shellcheck disable=SC2086
        gh workflow run "${WORKFLOW}" --ref "${REF}" ${INPUT_ARGS}
      env:
        GH_TOKEN: ${{ inputs.token }}
        REF: ${{ inputs.ref }}
        WORKFLOW: ${{ inputs.workflow }}
        INPUTS: ${{ inputs.inputs }}
      shell: bash
