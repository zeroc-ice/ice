<!-- Copyright (c) ZeroC, Inc. -->

<icegrid>
  <application name="Templates">

    <!-- Creates a Glacier2 router with activation mode "always" -->
    <server-template id="Glacier2">
      <parameter name="instance-name" default="${application}.Glacier2"/>
      <parameter name="client-endpoints"/>
      <parameter name="server-endpoints" default=""/>

      <server id="${instance-name}" exe="glacier2router" activation="always">
         <description>A Glacier2 router with activation mode "always".</description>
         <properties>
            <property name="Glacier2.Client.Endpoints" value="${client-endpoints}"/>
            <property name="Glacier2.Server.Endpoints" value="${server-endpoints}"/>
            <property name="Glacier2.InstanceName" value="${instance-name}"/>
         </properties>
      </server>
    </server-template>

    <!-- Creates an IceStorm service -->
    <service-template id="IceStorm">
      <!-- instance-name is the name of this IceStorm instance; it's used for IceStorm.InstanceName, in various adapter
           IDs, and also for the service name. -->
      <parameter name="instance-name" default="${application}.IceStorm"/>
      <parameter name="topic-manager-endpoints" default="default"/>
      <!-- publish-endpoints configures the IceStorm.Publish object adapter -->
      <parameter name="publish-endpoints" default="default"/>
      <parameter name="flush-timeout" default="1000"/>

      <!-- In general, the IceStorm service name should be simply "IceStorm". Using a configurable name allows us to
           load multiple IceStorm service instances in the same IceBox server - a rare use case. -->
      <service name="${instance-name}" entry="IceStormService,${node.ice.soversion}:createIceStorm">

        <description>An IceStorm service, hosted by an IceBox server.</description>
        <adapter name="IceStorm.TopicManager"
                 id="${instance-name}.TopicManager"
                 endpoints="${topic-manager-endpoints}">
          <object identity="${instance-name}/TopicManager" type="::IceStorm::TopicManager"/>
        </adapter>

        <adapter name="IceStorm.Publish" id="${instance-name}.Publish" endpoints="${publish-endpoints}"/>

        <properties>
           <property name="IceStorm.LMDB.Path" value="${service.data}"/>
           <property name="IceStorm.InstanceName" value="${instance-name}"/>
           <property name="IceStorm.Flush.Timeout" value="${flush-timeout}"/>
        </properties>
      </service>
    </service-template>

    <!-- Creates an IceBox server that loads a single IceStorm service. Its activation mode is "on-demand". -->
    <server-template id="IceStorm">
      <parameter name="instance-name" default="${application}.IceStorm"/>
      <parameter name="topic-manager-endpoints" default="default"/>
      <parameter name="publish-endpoints" default="default"/>
      <parameter name="flush-timeout" default="1000"/>

      <icebox id="${instance-name}" exe="icebox" activation="on-demand">
        <description>An IceBox server that loads a single IceStorm service.</description>
        <service-instance template="IceStorm"
                          instance-name="${instance-name}"
                          topic-manager-endpoints="${topic-manager-endpoints}"
                          publish-endpoints="${publish-endpoints}"
                          flush-timeout="${flush-timeout}"/>
      </icebox>
    </server-template>

    <!-- Creates an IceStorm service for a replicated / high availability deployment -->
    <service-template id="IceStorm-HA">
       <!-- instance-name is the name of this IceStorm instance; it's used for IceStorm.InstanceName, in various adapter
            IDs, and also in the service name. -->
      <parameter name="instance-name" default="${application}.IceStorm"/>
      <parameter name="node-id"/>
      <parameter name="topic-manager-endpoints" default="default"/>
      <!-- publish-endpoints configures the IceStorm.Publish object adapter -->
      <parameter name="publish-endpoints" default="default"/>
      <parameter name="node-endpoints" default="default"/>
      <parameter name="flush-timeout" default="1000"/>
      <parameter name="publish-replica-group"/>
      <parameter name="topic-manager-replica-group"/>

      <!-- In general, the IceStorm service name should be simply "IceStorm". Using a configurable name allows us to
           load multiple IceStorm service instances in the same IceBox server - a rare use case. -->
      <service name="${instance-name}${node-id}" entry="IceStormService,${node.ice.soversion}:createIceStorm">
        <description>An IceStorm service for a replicated / high availability deployment.</description>

        <adapter name="IceStorm.TopicManager"
                 id="${instance-name}${node-id}.TopicManager"
                 endpoints="${topic-manager-endpoints}"
                 replica-group="${topic-manager-replica-group}"/>

        <adapter name="IceStorm.Publish"
                 id="${instance-name}${node-id}.Publish"
                 endpoints="${publish-endpoints}"
                 replica-group="${publish-replica-group}"/>

        <adapter name="IceStorm.Node" id="${instance-name}${node-id}.Node" endpoints="${node-endpoints}"/>

        <properties>
           <property name="IceStorm.LMDB.Path" value="${service.data}"/>
           <property name="IceStorm.InstanceName" value="${instance-name}"/>
           <property name="IceStorm.NodeId" value="${node-id}"/>
           <property name="IceStorm.Flush.Timeout" value="${flush-timeout}"/>
        </properties>
      </service>
    </service-template>

    <!-- Creates an IceBox server that loads a single IceStorm-HA service. Its activation mode is "on-demand". -->
    <server-template id="IceStorm-HA">
      <parameter name="instance-name" default="${application}.IceStorm"/>
      <parameter name="node-id"/>
      <parameter name="topic-manager-endpoints" default="default"/>
      <parameter name="publish-endpoints" default="default"/>
      <parameter name="node-endpoints" default="default"/>
      <parameter name="flush-timeout" default="1000"/>
      <parameter name="publish-replica-group"/>
      <parameter name="topic-manager-replica-group"/>

      <icebox id="${instance-name}${node-id}" exe="icebox" activation="on-demand">
        <description>An IceBox server that loads a single IceStorm-HA service.</description>
        <service-instance template="IceStorm-HA"
                          instance-name="${instance-name}"
                          node-id="${node-id}"
                          topic-manager-endpoints="${topic-manager-endpoints}"
                          publish-endpoints="${publish-endpoints}"
                          node-endpoints="${node-endpoints}"
                          flush-timeout="${flush-timeout}"
                          publish-replica-group="${publish-replica-group}"
                          topic-manager-replica-group="${topic-manager-replica-group}"/>
      </icebox>
   </server-template>

  </application>
</icegrid>
