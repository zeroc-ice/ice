# Copyright (c) ZeroC, Inc.

# Creates the slice2swift artifact bundle for SwiftPM
#
# This rule creates a SwiftPM executable artifact bundle containing the slice2swift binary.
# The bundle is used by Package.swift to provide the slice2swift tool to the CompileSlice plugin.

slice2swift_artifactbundle_dir := bin/slice2swift.artifactbundle
slice2swift_artifactbundle := $(slice2swift_artifactbundle_dir).zip
slice2swift_platform := slice2swift-macos-arm64
slice2swift_info_template := $(lang_srcdir)/config/slice2swift.artifactbundle.info.json

$(slice2swift_artifactbundle): bin/slice2swift
	$(E) Creating $@
	$(Q)$(RM) -r $(@:.zip=)
	$(Q)$(MKDIR) -p $(@:.zip=)/$(slice2swift_platform)/bin
	$(Q)cp $< $(@:.zip=)/$(slice2swift_platform)/bin/slice2swift
	$(Q)sed 's/@VERSION@/$(version)/' $(slice2swift_info_template) > $(@:.zip=)/info.json
	$(Q)cd $(dir $(@:.zip=)) && zip -rq $(abspath $@) $(notdir $(@:.zip=))
	$(Q)$(RM) -r $(@:.zip=)

srcs all:: $(slice2swift_artifactbundle)

clean::
	$(E) Cleaning slice2swift artifact bundles
	$(Q)$(RM) -r $(slice2swift_artifactbundle) $(slice2swift_artifactbundle_dir)
